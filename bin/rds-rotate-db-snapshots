#!/usr/bin/env ruby

require_relative '../lib/rds_rotate_db_snapshots'

rrds = RdsRotateDbSnapshots.new(script_name: File.basename($0), cli: true)

if rrds.options[:aws_access_key].nil? || rrds.options[:aws_secret_access_key].nil?
  puts "You must specify your Amazon credentials via --aws-access-key and --aws-secret_access-key and --aws-session-token"
  exit 1
end

if rrds.options[:aws_region].nil?
  puts "You must specify your AWS Region via --aws-region"
  exit 1
end

if ARGV.empty? and rrds.options[:by_tags].nil?
  puts "You must provide at least one DB Indentifier when not rotating by tags"
  exit 1
end

if rrds.options[:by_tags].nil?
  db_indentifier_ids = ARGV

  db_indentifier_ids.each do |db_id|
    if db_id.nil? or db_id.gsub(/\s/, '').size < 1
      # sanity check
      puts "Invalid db indentifier: #{db_id}"
      exit 1
    end
  end
else
  if !ARGV.empty?
    puts "Ignoring supplied db_indentifier_ids because we're rotating by tags."
  end
  if rrds.options[:by_tags].length == 0
    puts "Rotating by tags but no tags specified? Refusing to rotate all snapshots!"
    exit 1
  end
end

if rrds.options[:backoff_limit] < 0
  puts "A negative backoff limit doesn't make much sense."
  exit 1
end

if rrds.options[:create_snapshot]
  rrds.create_snapshot(rrds.options[:create_snapshot], db_indentifier_ids)
end

all_snapshots = []
if rrds.options[:by_tags]
  rrds.rotate_by_tags
else
  snapshots = rrds.get_db_snapshots(snapshot_type: 'manual').delete_if{ |e| e[:status] != 'available' }
  db_indentifier_ids.each do |db_id|
    rrds.rotate_em(
      snapshots.select {|ss| ss[:db_instance_identifier] == db_id }.
        sort {|a,b| a[:snapshot_create_time] <=> b[:snapshot_create_time] }
    )
  end
end
